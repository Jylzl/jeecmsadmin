(function(){function initTabs(){for(var e=$G("tabhead").children,t=0;t<e.length;t++)domUtils.on(e[t],"click",function(e){var t=e.target||e.srcElement;setTabFocus(t.getAttribute("data-content-id"))});var i=editor.selection.getRange().getClosedNode();i&&i.tagName&&"img"==i.tagName.toLowerCase()?setTabFocus("remote"):setTabFocus("upload")}function setTabFocus(e){if(e){var t,i,a=$G("tabhead").children;for(t=0;t<a.length;t++)i=a[t].getAttribute("data-content-id"),i==e?(domUtils.addClass(a[t],"focus"),domUtils.addClass($G(i),"focus")):(domUtils.removeClasses(a[t],"focus"),domUtils.removeClasses($G(i),"focus"));switch(e){case"remote":remoteImage=remoteImage||new RemoteImage;break;case"upload":setAlign(editor.getOpt("imageInsertAlign")),uploadImage=uploadImage||new UploadImage("queueList");break;case"online":setAlign(editor.getOpt("imageManagerInsertAlign")),onlineImage=onlineImage||new OnlineImage("imageList"),onlineImage.reset();break;case"search":setAlign(editor.getOpt("imageManagerInsertAlign")),searchImage=searchImage||new SearchImage}}}function initButtons(){dialog.onok=function(){for(var e,t=!1,i=[],a=$G("tabhead").children,n=0;n<a.length;n++)if(domUtils.hasClass(a[n],"focus")){e=a[n].getAttribute("data-content-id");break}switch(e){case"remote":i=remoteImage.getInsertList();break;case"upload":i=uploadImage.getInsertList();var s=uploadImage.getQueueCount();if(s)return $(".info","#queueList").html('<span style="color:red;">'+"还有2个未上传文件".replace(/[\d]/,s)+"</span>"),!1;break;case"online":i=onlineImage.getInsertList();break;case"search":i=searchImage.getInsertList(),t=!0}i&&(editor.execCommand("insertimage",i),t&&editor.fireEvent("catchRemoteImage"))}}function initAlign(){domUtils.on($G("alignIcon"),"click",function(e){var t=e.target||e.srcElement;t.className&&-1!=t.className.indexOf("-align")&&setAlign(t.getAttribute("data-align"))})}function setAlign(e){e=e||"none";var t=$G("alignIcon").children;for(i=0;i<t.length;i++)t[i].getAttribute("data-align")==e?(domUtils.addClass(t[i],"focus"),$G("align").value=t[i].getAttribute("data-align")):domUtils.removeClasses(t[i],"focus")}function getAlign(){var e=$G("align").value||"none";return"none"==e?"":e}function RemoteImage(e){this.container=utils.isString(e)?document.getElementById(e):e,this.init()}function UploadImage(e){this.$wrap=e.constructor==String?$("#"+e):$(e),this.init()}function OnlineImage(e){this.container=utils.isString(e)?document.getElementById(e):e,this.init()}function SearchImage(){this.init()}var remoteImage,uploadImage,onlineImage,searchImage;window.onload=function(){initTabs(),initAlign(),initButtons()},RemoteImage.prototype={init:function(){this.initContainer(),this.initEvents()},initContainer:function(){this.dom={url:$G("url"),width:$G("width"),height:$G("height"),border:$G("border"),vhSpace:$G("vhSpace"),title:$G("title"),align:$G("align")};var e=editor.selection.getRange().getClosedNode();e&&this.setImage(e)},initEvents:function(){function e(){t.setPreview()}var t=this,i=$G("lock");domUtils.on($G("url"),"keyup",e),domUtils.on($G("border"),"keyup",e),domUtils.on($G("title"),"keyup",e),domUtils.on($G("width"),"keyup",function(){if(i.checked){var a=i.getAttribute("data-proportion");$G("height").value=Math.round(this.value/a)}else t.updateLocker();e()}),domUtils.on($G("height"),"keyup",function(){if(i.checked){var a=i.getAttribute("data-proportion");$G("width").value=Math.round(this.value*a)}else t.updateLocker();e()}),domUtils.on($G("lock"),"change",function(){var e=parseInt($G("width").value)/parseInt($G("height").value);i.setAttribute("data-proportion",e)})},updateLocker:function(){var e=$G("width").value,t=$G("height").value,i=$G("lock");e&&t&&e==parseInt(e)&&t==parseInt(t)?(i.disabled=!1,i.title=""):(i.checked=!1,i.disabled="disabled",i.title=lang.remoteLockError)},setImage:function(e){if(e.tagName&&("img"==e.tagName.toLowerCase()||e.getAttribute("src"))&&e.src){var t=e.getAttribute("word_img"),i=t?t.replace("&amp;","&"):e.getAttribute("_src")||e.getAttribute("src",2).replace("&amp;","&"),a=editor.queryCommandValue("imageFloat");i!==$G("url").value&&($G("url").value=i),i&&($G("width").value=e.width||"",$G("height").value=e.height||"",$G("border").value=e.getAttribute("border")||"0",$G("vhSpace").value=e.getAttribute("vspace")||"0",$G("title").value=e.title||e.alt||"",setAlign(a),this.setPreview(),this.updateLocker())}},getData:function(){var e={};for(var t in this.dom)e[t]=this.dom[t].value;return e},setPreview:function(){var e,t,i=$G("url").value,a=$G("width").value,n=$G("height").value,s=$G("border").value,r=$G("title").value,o=$G("preview");e=a&&n?Math.min(a,o.offsetWidth):o.offsetWidth,e=e+2*s>o.offsetWidth?e:o.offsetWidth-2*s,t=a&&n?e*n/a:"",i&&(o.innerHTML='<img src="'+i+'" width="'+e+'" height="'+t+'" border="'+s+'px solid #000" title="'+r+'" />')},getInsertList:function(){var e=this.getData();return e.url?[{src:e.url,_src:e.url,width:e.width||"",height:e.height||"",border:e.border||"",floatStyle:e.align||"",vspace:e.vhSpace||"",alt:e.title||"",style:"width:"+e.width+"px;height:"+e.height+"px;"}]:[]}},UploadImage.prototype={init:function(){this.imageList=[],this.initContainer(),this.initUploader()},initContainer:function(){this.$queue=this.$wrap.find(".filelist")},initUploader:function(){function e(e){var t=d('<li id="'+e.id+'"><p class="title">'+e.name+'</p><p class="imgWrap"></p><p class="progress"><span></span></p></li>'),i=d('<div class="file-panel"><span class="cancel">'+lang.uploadDelete+'</span><span class="rotateRight">'+lang.uploadTurnRight+'</span><span class="rotateLeft">'+lang.uploadTurnLeft+"</span></div>").appendTo(t),a=t.find("p.progress span"),n=t.find("p.imgWrap"),r=d('<p class="error"></p>').hide().appendTo(t),o=function(e){switch(e){case"exceed_size":text=lang.errorExceedSize;break;case"interrupt":text=lang.errorInterrupt;break;case"http":text=lang.errorHttp;break;case"not_allow_type":text=lang.errorFileType;break;default:text=lang.errorUploadRetry}r.text(text).show()};"invalid"===e.getStatus()?o(e.statusText):(n.text(lang.uploadPreview),browser.ie&&browser.version<=7?n.text(lang.uploadNoPreview):s.makeThumb(e,function(e,t){if(e||!t)n.text(lang.uploadNoPreview);else{var i=d('<img src="'+t+'">');n.empty().append(i),i.on("error",function(){n.text(lang.uploadNoPreview)})}},C,x),U[e.id]=[e.size,0],e.rotation=0,e.ext&&-1!=L.indexOf(e.ext.toLowerCase())||(o("not_allow_type"),s.removeFile(e))),e.on("statuschange",function(n,s){"progress"===s?a.hide().width(0):"queued"===s&&(t.off("mouseenter mouseleave"),i.remove()),"error"===n||"invalid"===n?(o(e.statusText),U[e.id][1]=1):"interrupt"===n?o("interrupt"):"queued"===n?U[e.id][1]=0:"progress"===n&&(r.hide(),a.css("display","block")),t.removeClass("state-"+s).addClass("state-"+n)}),t.on("mouseenter",function(){i.stop().animate({height:30})}),t.on("mouseleave",function(){i.stop().animate({height:0})}),i.on("click","span",function(){var t,i=d(this).index();switch(i){case 0:return void s.removeFile(e);case 1:e.rotation+=90;break;case 2:e.rotation-=90}k?(t="rotate("+e.rotation+"deg)",n.css({"-webkit-transform":t,"-mos-transform":t,"-o-transform":t,transform:t})):n.css("filter","progid:DXImageTransform.Microsoft.BasicImage(rotation="+~~(e.rotation/90%4+4)%4+")")}),t.insertBefore(m)}function t(e){var t=d("#"+e.id);delete U[e.id],i(),t.off().find(".file-panel").off().end().remove()}function i(){var e,t=0,i=0,a=v.children();d.each(U,function(e,a){i+=a[0],t+=a[0]*a[1]}),e=i?t/i:0,a.eq(0).text(Math.round(100*e)+"%"),a.eq(1).css("width",Math.round(100*e)+"%"),n()}function a(e,t){if(e!=$){var i=s.getStats();switch(p.removeClass("state-"+$),p.addClass("state-"+e),e){case"pedding":u.addClass("element-invisible"),g.addClass("element-invisible"),f.removeClass("element-invisible"),v.hide(),h.hide(),s.refresh();break;case"ready":f.addClass("element-invisible"),u.removeClass("element-invisible"),g.removeClass("element-invisible"),v.hide(),h.show(),p.text(lang.uploadStart),s.refresh();break;case"uploading":v.show(),h.hide(),p.text(lang.uploadPause);break;case"paused":v.show(),h.hide(),p.text(lang.uploadContinue);break;case"confirm":if(v.show(),h.hide(),p.text(lang.uploadStart),i=s.getStats(),i.successNum&&!i.uploadFailNum)return void a("finish");break;case"finish":v.hide(),h.show(),i.uploadFailNum?p.text(lang.uploadRetry):p.text(lang.uploadStart)}$=e,n()}l.getQueueCount()?p.removeClass("disabled"):p.addClass("disabled")}function n(){var e,t="";"ready"===$?t=lang.updateStatusReady.replace("_",w).replace("_KB",WebUploader.formatSize(b)):"confirm"===$?(e=s.getStats(),e.uploadFailNum&&(t=lang.updateStatusConfirm.replace("_",e.successNum).replace("_",e.successNum))):(e=s.getStats(),t=lang.updateStatusFinish.replace("_",w).replace("_KB",WebUploader.formatSize(b)).replace("_",e.successNum),e.uploadFailNum&&(t+=lang.updateStatusError.replace("_",e.uploadFailNum))),h.html(t)}var s,r,o,l=this,d=jQuery,c=l.$wrap,u=c.find(".filelist"),g=c.find(".statusBar"),h=g.find(".info"),p=c.find(".uploadBtn"),m=(c.find(".filePickerBtn"),c.find(".filePickerBlock")),f=c.find(".placeholder"),v=g.find(".progress").hide(),w=0,b=0,I=window.devicePixelRatio||1,C=113*I,x=113*I,$="",U={},k=(r=document.createElement("p").style,o="transition"in r||"WebkitTransition"in r||"MozTransition"in r||"msTransition"in r||"OTransition"in r,r=null,o),G=editor.getActionUrl(editor.getOpt("imageActionName")),L=(editor.getOpt("imageAllowFiles")||[".png",".jpg",".jpeg",".gif",".bmp"]).join("").replace(/\./g,",").replace(/^[,]/,""),y=editor.getOpt("imageMaxSize");editor.getOpt("imageCompressBorder");WebUploader.Uploader.support()?editor.getOpt("imageActionName")?(s=l.uploader=WebUploader.create({pick:{id:"#filePickerReady",label:lang.uploadSelectFile},accept:{title:"Images",extensions:L,mimeTypes:"image/jpeg,image/png,image/svg,image/webp,image/gif"},swf:"../../third-party/webuploader/Uploader.swf",server:G,fileVal:editor.getOpt("imageFieldName"),duplicate:!0,fileSingleSizeLimit:y,compress:!1}),s.addButton({id:"#filePickerBlock"}),s.addButton({id:"#filePickerBtn",label:lang.uploadAddFile}),a("pedding"),s.on("fileQueued",function(t){editor.getOpt("imageUploadService")(l,editor).setUploadData(t),w++,b+=t.size,1===w&&(f.addClass("element-invisible"),g.show()),e(t)}),s.on("fileDequeued",function(e){e.ext&&-1!=L.indexOf(e.ext.toLowerCase())&&e.size<=y&&(w--,b-=e.size),t(e),i()}),s.on("filesQueued",function(e){s.isInProgress()||"pedding"!=$&&"finish"!=$&&"confirm"!=$&&"ready"!=$||a("ready"),i()}),s.on("all",function(e,t){switch(e){case"uploadFinished":a("confirm",t);break;case"startUpload":editor.getOpt("imageUploadService")(l,editor).setUploaderOptions(s),a("uploading",t);break;case"stopUpload":a("paused",t)}}),s.on("uploadBeforeSend",function(e,t,i){editor.getOpt("imageUploadService")(l,editor).setFormData(e,t,i)}),s.on("uploadProgress",function(e,t){var a=d("#"+e.id),n=a.find(".progress span");n.css("width",100*t+"%"),U[e.id][1]=t,i()}),s.on("uploadSuccess",function(e,t){var i=d("#"+e.id);try{editor.getOpt("imageUploadService")(l,editor).getResponseSuccess(t)?(l.imageList.push(t),i.append('<span class="success"></span>')):i.find(".error").text(t.message).show()}catch(e){i.find(".error").text(lang.errorServerUpload).show()}}),s.on("uploadError",function(e,t){}),s.on("error",function(t,i){"Q_TYPE_DENIED"!=t&&"F_EXCEED_SIZE"!=t||e(i)}),s.on("uploadComplete",function(e,t){}),p.on("click",function(){if(d(this).hasClass("disabled"))return!1;"ready"===$?window.setTimeout(function(){s.upload()},500):"paused"===$?window.setTimeout(function(){s.upload()},500):"uploading"===$&&s.stop()}),p.addClass("state-"+$),i()):d("#filePickerReady").after(d("<div>").html(lang.errorLoadConfig)).hide():d("#filePickerReady").after(d("<div>").html(lang.errorNotSupport)).hide()},getQueueCount:function(){var e,t,i,a=0,n=this.uploader.getFiles();for(t=0;e=n[t++];)i=e.getStatus(),"queued"!=i&&"uploading"!=i&&"progress"!=i||a++;return a},destroy:function(){this.$wrap.remove()},getInsertList:function(){var e,t,i=[],a=getAlign(),n=editor.getOpt("imageUrlPrefix"),s=editor.getOpt("imageUploadService")(this,editor).imageSrcField||"url",r="",o=s.split(".");for(e=0;e<this.imageList.length;e++){if(t=this.imageList[e],o.length>1){function l(e,t,i){e=e[t[i]],i<t.length-1?l(e,t,i+=1):r=e}l(t,o,0)}else r=t[s];i.push({src:n+r,_src:n+r,alt:t.original,floatStyle:a})}return i}},OnlineImage.prototype={init:function(){this.reset(),this.initEvents()},initContainer:function(){this.container.innerHTML="",this.list=document.createElement("ul"),this.clearFloat=document.createElement("li"),domUtils.addClass(this.list,"list"),domUtils.addClass(this.clearFloat,"clearFloat"),this.list.appendChild(this.clearFloat),this.container.appendChild(this.list)},initEvents:function(){var e=this;domUtils.on($G("imageList"),"scroll",function(t){var i=this;i.scrollHeight-(i.offsetHeight+i.scrollTop)<10&&e.getImageData()}),domUtils.on(this.container,"click",function(e){var t=e.target||e.srcElement,i=t.parentNode;"li"==i.tagName.toLowerCase()&&(domUtils.hasClass(i,"selected")?domUtils.removeClasses(i,"selected"):domUtils.addClass(i,"selected"))})},initData:function(){this.state=0,this.listSize=editor.getOpt("imageManagerListSize"),this.listIndex=0,this.listEnd=!1,this.getImageData()},reset:function(){this.initContainer(),this.initData()},getImageData:function(){var _this=this;if(!_this.listEnd&&!this.isLoadingData){this.isLoadingData=!0;var url=editor.getActionUrl(editor.getOpt("imageManagerActionName")),isJsonp=utils.isCrossDomainUrl(url);ajax.request(url,{timeout:1e5,dataType:isJsonp?"jsonp":"",data:utils.extend({start:this.listIndex,size:this.listSize},editor.queryCommandValue("serverparam")),method:"get",onsuccess:function(r){try{var json=isJsonp?r:eval("("+r.responseText+")");"SUCCESS"==json.state&&(_this.pushData(json.list),_this.listIndex=parseInt(json.start)+parseInt(json.list.length),_this.listIndex>=json.total&&(_this.listEnd=!0),_this.isLoadingData=!1)}catch(e){if(-1!=r.responseText.indexOf("ue_separate_ue")){var list=r.responseText.split(r.responseText);_this.pushData(list),_this.listIndex=parseInt(list.length),_this.listEnd=!0,_this.isLoadingData=!1}}},onerror:function(){_this.isLoadingData=!1}})}},pushData:function(e){var t,i,a,n,s=this,r=editor.getOpt("imageManagerUrlPrefix");for(t=0;t<e.length;t++)e[t]&&e[t].url&&(i=document.createElement("li"),a=document.createElement("img"),n=document.createElement("span"),domUtils.on(a,"load",function(e){return function(){s.scale(e,e.parentNode.offsetWidth,e.parentNode.offsetHeight)}}(a)),a.width=113,a.setAttribute("src",r+e[t].url+(-1==e[t].url.indexOf("?")?"?noCache=":"&noCache=")+(+new Date).toString(36)),a.setAttribute("_src",r+e[t].url),domUtils.addClass(n,"icon"),i.appendChild(a),i.appendChild(n),this.list.insertBefore(i,this.clearFloat))},scale:function(e,t,i,a){var n=e.width,s=e.height;"justify"==a?n>=s?(e.width=t,e.height=i*s/n,e.style.marginLeft="-"+parseInt((e.width-t)/2)+"px"):(e.width=t*n/s,e.height=i,e.style.marginTop="-"+parseInt((e.height-i)/2)+"px"):n>=s?(e.width=t*n/s,e.height=i,e.style.marginLeft="-"+parseInt((e.width-t)/2)+"px"):(e.width=t,e.height=i*s/n,e.style.marginTop="-"+parseInt((e.height-i)/2)+"px")},getInsertList:function(){var e,t=this.list.children,i=[],a=getAlign();for(e=0;e<t.length;e++)if(domUtils.hasClass(t[e],"selected")){var n=t[e].firstChild,s=n.getAttribute("_src");i.push({src:s,_src:s,alt:s.substr(s.lastIndexOf("/")+1),floatStyle:a})}return i}},SearchImage.prototype={init:function(){this.initEvents()},initEvents:function(){var e=this;domUtils.on($G("searchBtn"),"click",function(){var t=$G("searchTxt").value;t&&t!=lang.searchRemind&&e.getImageData()}),domUtils.on($G("searchReset"),"click",function(){$G("searchTxt").value=lang.searchRemind,$G("searchListUl").innerHTML="",$G("searchType").selectedIndex=0}),domUtils.on($G("searchTxt"),"focus",function(){var e=$G("searchTxt").value;e&&e==lang.searchRemind&&($G("searchTxt").value="")}),domUtils.on($G("searchTxt"),"keydown",function(e){var t=e.keyCode||e.which;13==t&&$G("searchBtn").click()}),domUtils.on($G("searchList"),"click",function(e){var t=e.target||e.srcElement,i=t.parentNode.parentNode;"li"==i.tagName.toLowerCase()&&(domUtils.hasClass(i,"selected")?domUtils.removeClasses(i,"selected"):domUtils.addClass(i,"selected"))})},scale:function(e,t,i){var a=e.width,n=e.height;a>=n?(e.width=t*a/n,e.height=i,e.style.marginLeft="-"+parseInt((e.width-t)/2)+"px"):(e.width=t,e.height=i*n/a,e.style.marginTop="-"+parseInt((e.height-i)/2)+"px")},getImageData:function(){var e=this,t=$G("searchTxt").value,i=$G("searchType").value,a=(editor.options.keepOriginName,$G("pageNum").value),n="https://image.baidu.com/search/acjson?tn=resultjson_com&ipn=rj&ct=201326592&is=&fp=result&queryWord="+t+"&cl=2"+i+"&ie=utf-8&oe=utf-8&adpicid=&z=&ic=0&word="+t+"&se=&tab=&width=&height=&istype=2&qc=&nc=1&fr=&pn=60&rn="+a+"&gsm=78&"+new Date+"=";$G("searchListUl").innerHTML=lang.searchLoading,ajax.request(n,{dataType:"jsonp",onsuccess:function(t){var i=[];if(t&&t.data)for(var a=0;a<t.data.length;a++)t.data[a].objURL&&i.push({title:t.data[a].fromPageTitleEnc,src:t.data[a].thumbURL,url:t.data[a].thumbURL});e.setList(i)},onerror:function(){$G("searchListUl").innerHTML=lang.searchRetry}})},setList:function(e){var t,i,a,n,s,r=this,o=$G("searchListUl");if(o.innerHTML="",e.length)for(t=0;t<e.length;t++)i=document.createElement("li"),a=document.createElement("p"),n=document.createElement("img"),s=document.createElement("a"),n.onload=function(){r.scale(this,113,113)},n.width=113,n.setAttribute("src",e[t].src),s.href=e[t].url,s.target="_blank",s.title=e[t].title,s.innerHTML=e[t].title,a.appendChild(n),i.appendChild(a),i.appendChild(s),o.appendChild(i);else o.innerHTML=lang.searchRetry},getInsertList:function(){for(var e,t,i=getAlign(),a=[],n=$G("searchListUl").children,s=0;s<n.length;s++)e=n[s].firstChild&&n[s].firstChild.firstChild,e.tagName&&"img"==e.tagName.toLowerCase()&&domUtils.hasClass(n[s],"selected")&&(t=e.src,a.push({src:t,_src:t,alt:t.substr(t.lastIndexOf("/")+1),floatStyle:i}));return a}}})();