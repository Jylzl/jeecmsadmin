(function(){function e(){for(var e=$G("tabHeads").children,t=0;t<e.length;t++)domUtils.on(e[t],"click",function(t){var i,a,o=t.target||t.srcElement;for(i=0;i<e.length;i++)a=e[i].getAttribute("data-content-id"),e[i]==o?(domUtils.addClass(e[i],"focus"),domUtils.addClass($G(a),"focus")):(domUtils.removeClasses(e[i],"focus"),domUtils.removeClasses($G(a),"focus"))})}function t(){u(["videoFloat","upload_alignment"]),p($G("videoUrl")),i(),function(){var e,t=editor.selection.getRange().getClosedNode();if(t&&t.className){var i="edui-faked-video"==t.className,o=-1!=t.className.indexOf("edui-upload-video");if(i||o){$G("videoUrl").value=e=t.getAttribute("_url"),$G("videoWidth").value=t.width,$G("videoHeight").value=t.height;var r=domUtils.getComputedStyle(t,"float"),n=domUtils.getComputedStyle(t.parentNode,"text-align");a("center"===n?"center":r)}o&&(b=!0)}f(e)}()}function i(){dialog.onok=function(){$G("preview").innerHTML="";var e=n("tabHeads","tabSrc");switch(e){case"video":return o();case"videoSearch":return r("searchList");case"upload":return v()}},dialog.oncancel=function(){$G("preview").innerHTML=""}}function a(e){for(var t,i=$G("videoFloat").children,a=0;t=i[a++];)t.getAttribute("name")==e?"focus"!=t.className&&(t.className="focus"):"focus"==t.className&&(t.className="")}function o(){var e=$G("videoWidth"),t=$G("videoHeight"),i=$G("videoUrl").value,a=n("videoFloat","name"),o=s(i);if(o.startsWith("<embed"))for(var r=o.split(" "),d=0;d<r.length;d++)r[d].startsWith("src")&&(o=r[d].replace("src=","")),r[d].startsWith("width")&&(e||(e=r[d].replace("width=",""))),r[d].startsWith("height")&&(t||(t=r[d].replace("height=","")));return!!o&&(!!l([e,t])&&void editor.execCommand("insertvideo",{url:o,width:e.value,height:t.value,align:a},b?"upload":null))}function r(e){for(var t,i=domUtils.getElementsByTagName($G(e),"img"),a=[],o=0;t=i[o++];)t.getAttribute("selected")&&a.push({url:t.getAttribute("ue_video_url"),width:420,height:280,align:"none"});editor.execCommand("insertvideo",a)}function n(e,t){for(var i,a,o=$G(e).children,r=0;a=o[r++];)if("focus"==a.className){i=a.getAttribute(t);break}return i}function s(e){if(!e)return"";var t=e.split("?");return t&&t.length>1&&(e=t[0]),e=utils.trim(e).replace(/v\.youku\.com\/v_show\/id_([\w\-=]+)\.html/i,"player.youku.com/player.php/sid/$1/v.swf").replace(/(www\.)?youtube\.com\/watch\?v=([\w\-]+)/i,"www.youtube.com/v/$2").replace(/youtu.be\/(\w+)$/i,"www.youtube.com/v/$1").replace(/v\.ku6\.com\/.+\/([\w\.]+)\.html.*$/i,"player.ku6.com/refer/$1/v.swf").replace(/www\.56\.com\/u\d+\/v_([\w\-]+)\.html/i,"player.56.com/v_$1.swf").replace(/www.56.com\/w\d+\/play_album\-aid\-\d+_vid\-([^.]+)\.html/i,"player.56.com/v_$1.swf").replace(/v\.pps\.tv\/play_([\w]+)\.html.*$/i,"player.pps.tv/player/sid/$1/v.swf").replace(/www\.letv\.com\/ptv\/vplay\/([\d]+)\.html.*$/i,"i7.imgs.letv.com/player/swfPlayer.swf?id=$1&autoplay=0").replace(/www\.tudou\.com\/programs\/view\/([\w\-]+)\/?/i,"www.tudou.com/v/$1").replace(/v\.qq\.com\/cover\/[\w]+\/[\w]+\/([\w]+)\.html/i,"static.video.qq.com/TPout.swf?vid=$1").replace(/v\.qq\.com\/.+[\?\&]vid=([^&]+).*$/i,"static.video.qq.com/TPout.swf?vid=$1").replace(/my\.tv\.sohu\.com\/[\w]+\/[\d]+\/([\d]+)\.shtml.*$/i,"share.vrs.sohu.com/my/v.swf&id=$1"),e}function l(e){for(var t,i=0;t=e[i++];){var a=t.value;if(!d(a)&&a)return alert(lang.numError),t.value="",t.focus(),!1}return!0}function d(e){return/(0|^[1-9]\d*$)/.test(e)}function u(e){for(var t,i=0;t=e[i++];){var a=$G(t),o={none:lang.default,left:lang.floatLeft,right:lang.floatRight,center:lang.block};for(var r in o){var n=document.createElement("div");n.setAttribute("name",r),"none"==r&&(n.className="focus"),n.style.cssText="background:url(images/"+r+"_focus.jpg);",n.setAttribute("title",o[r]),a.appendChild(n)}c(t)}}function c(e){for(var t,i=$G(e).children,a=0;t=i[a++];)domUtils.on(t,"click",function(){for(var e,t=0;e=i[t++];)e.className="",e.removeAttribute&&e.removeAttribute("class");this.className="focus"})}function p(e){browser.ie?e.onpropertychange=function(){f(this.value)}:e.addEventListener("input",function(){f(this.value)},!1)}function f(e){e&&(e.startsWith("http")&&e.indexOf(".mp4")>0&&($G("preview").innerHTML='<div class="previewMsg"><span>'+lang.urlError+'</span></div><video class="previewVideo" src="'+e+'" width="420" height="280" play="true" loop="false" data-setup="{}" controls="controls" preload="auto"></video>'),e.startsWith("<embed>")&&($G("preview").innerHTML='<div class="previewMsg"><span>'+lang.urlError+"</span></div>"+e))}function v(){var e=[],t=editor.getOpt("videoUrlPrefix"),i=$G("upload_width").value||420,a=$G("upload_height").value||280,o=n("upload_alignment","name")||"none",r=editor.getOpt("imageUploadService")(this,editor).videoSrcField||"url",s="",l=r.split(".");for(var d in w){var u=w[d];if(l.length>1){function c(e,t,i){e=e[t[i]],i<t.length-1?c(e,t,i+=1):s=e}c(u,l,0)}else s=u[r];e.push({url:t+s,width:i,height:a,align:o})}var p=h.getQueueCount();if(p)return $(".info","#queueList").html('<span style="color:red;">'+"还有2个未上传文件".replace(/[\d]/,p)+"</span>"),!1;editor.execCommand("insertvideo",e,"upload")}function m(){h=new g("queueList")}function g(e){this.$wrap=e.constructor==String?$("#"+e):$(e),this.init()}var h,w=[],b=!1;window.onload=function(){$focus($G("videoUrl")),e(),t(),m()},g.prototype={init:function(){this.fileList=[],this.initContainer(),this.initUploader()},initContainer:function(){this.$queue=this.$wrap.find(".filelist")},initUploader:function(){function e(e){var t=d('<li id="'+e.id+'"><p class="title">'+e.name+'</p><p class="imgWrap"></p><p class="progress"><span></span></p></li>'),i=d('<div class="file-panel"><span class="cancel">'+lang.uploadDelete+'</span><span class="rotateRight">'+lang.uploadTurnRight+'</span><span class="rotateLeft">'+lang.uploadTurnLeft+"</span></div>").appendTo(t),a=t.find("p.progress span"),o=t.find("p.imgWrap"),n=d('<p class="error"></p>').hide().appendTo(t),s=function(e){switch(e){case"exceed_size":text=lang.errorExceedSize;break;case"interrupt":text=lang.errorInterrupt;break;case"http":text=lang.errorHttp;break;case"not_allow_type":text=lang.errorFileType;break;default:text=lang.errorUploadRetry}n.text(text).show()};"invalid"===e.getStatus()?s(e.statusText):(o.text(lang.uploadPreview),-1=="|png|jpg|jpeg|bmp|gif|".indexOf("|"+e.ext.toLowerCase()+"|")?o.empty().addClass("notimage").append('<i class="file-preview file-type-'+e.ext.toLowerCase()+'"></i><span class="file-title">'+e.name+"</span>"):browser.ie&&browser.version<=7?o.text(lang.uploadNoPreview):r.makeThumb(e,function(e,t){if(e||!t||/^data:/.test(t)&&browser.ie&&browser.version<=7)o.text(lang.uploadNoPreview);else{var i=d('<img src="'+t+'">');o.empty().append(i),i.on("error",function(){o.text(lang.uploadNoPreview)})}},x,C),S[e.id]=[e.size,0],e.rotation=0,e.ext&&-1!=T.indexOf(e.ext.toLowerCase())||(s("not_allow_type"),r.removeFile(e))),e.on("statuschange",function(o,r){"progress"===r?a.hide().width(0):"queued"===r&&(t.off("mouseenter mouseleave"),i.remove()),"error"===o||"invalid"===o?(s(e.statusText),S[e.id][1]=1):"interrupt"===o?s("interrupt"):"queued"===o?S[e.id][1]=0:"progress"===o&&(n.hide(),a.css("display","block")),t.removeClass("state-"+r).addClass("state-"+o)}),t.on("mouseenter",function(){i.stop().animate({height:30})}),t.on("mouseleave",function(){i.stop().animate({height:0})}),i.on("click","span",function(){var t,i=d(this).index();switch(i){case 0:return void r.removeFile(e);case 1:e.rotation+=90;break;case 2:e.rotation-=90}U?(t="rotate("+e.rotation+"deg)",o.css({"-webkit-transform":t,"-mos-transform":t,"-o-transform":t,transform:t})):o.css("filter","progid:DXImageTransform.Microsoft.BasicImage(rotation="+~~(e.rotation/90%4+4)%4+")")}),t.insertBefore(m)}function t(e){var t=d("#"+e.id);delete S[e.id],i(),t.off().find(".file-panel").off().end().remove()}function i(){var e,t=0,i=0,a=h.children();d.each(S,function(e,a){i+=a[0],t+=a[0]*a[1]}),e=i?t/i:0,a.eq(0).text(Math.round(100*e)+"%"),a.eq(1).css("width",Math.round(100*e)+"%"),o()}function a(e,t){if(e!=k){var i=r.getStats();switch(v.removeClass("state-"+k),v.addClass("state-"+e),e){case"pedding":c.addClass("element-invisible"),p.addClass("element-invisible"),g.removeClass("element-invisible"),h.hide(),f.hide(),r.refresh();break;case"ready":g.addClass("element-invisible"),c.removeClass("element-invisible"),p.removeClass("element-invisible"),h.hide(),f.show(),v.text(lang.uploadStart),r.refresh();break;case"uploading":h.show(),f.hide(),v.text(lang.uploadPause);break;case"paused":h.show(),f.hide(),v.text(lang.uploadContinue);break;case"confirm":if(h.show(),f.hide(),v.text(lang.uploadStart),i=r.getStats(),i.successNum&&!i.uploadFailNum)return void a("finish");break;case"finish":h.hide(),f.show(),i.uploadFailNum?v.text(lang.uploadRetry):v.text(lang.uploadStart)}k=e,o()}l.getQueueCount()?v.removeClass("disabled"):v.addClass("disabled")}function o(){var e,t="";"ready"===k?t=lang.updateStatusReady.replace("_",b).replace("_KB",WebUploader.formatSize(y)):"confirm"===k?(e=r.getStats(),e.uploadFailNum&&(t=lang.updateStatusConfirm.replace("_",e.successNum).replace("_",e.successNum))):(e=r.getStats(),t=lang.updateStatusFinish.replace("_",b).replace("_KB",WebUploader.formatSize(y)).replace("_",e.successNum),e.uploadFailNum&&(t+=lang.updateStatusError.replace("_",e.uploadFailNum))),f.html(t)}var r,n,s,l=this,d=jQuery,u=l.$wrap,c=u.find(".filelist"),p=u.find(".statusBar"),f=p.find(".info"),v=u.find(".uploadBtn"),m=(u.find(".filePickerBtn"),u.find(".filePickerBlock")),g=u.find(".placeholder"),h=p.find(".progress").hide(),b=0,y=0,$=window.devicePixelRatio||1,x=113*$,C=113*$,k="",S={},U=(n=document.createElement("p").style,s="transition"in n||"WebkitTransition"in n||"MozTransition"in n||"msTransition"in n||"OTransition"in n,n=null,s),_=editor.getActionUrl(editor.getOpt("videoActionName")),N=editor.getOpt("videoMaxSize"),T=(editor.getOpt("videoAllowFiles")||[".mp4",".webm",".flv",".ogg",".f4v"]).join("").replace(/\./g,",").replace(/^[,]/,"");WebUploader.Uploader.support()?editor.getOpt("videoActionName")?(r=l.uploader=WebUploader.create({pick:{id:"#filePickerReady",label:lang.uploadSelectFile},swf:"../../third-party/webuploader/Uploader.swf",server:_,fileVal:editor.getOpt("videoFieldName"),duplicate:!0,fileSingleSizeLimit:N,compress:!1}),r.addButton({id:"#filePickerBlock"}),r.addButton({id:"#filePickerBtn",label:lang.uploadAddFile}),a("pedding"),r.on("fileQueued",function(t){editor.getOpt("videoUploadService")(l,editor).setUploadData(t),b++,y+=t.size,1===b&&(g.addClass("element-invisible"),p.show()),e(t)}),r.on("fileDequeued",function(e){b--,y-=e.size,t(e),i()}),r.on("filesQueued",function(e){r.isInProgress()||"pedding"!=k&&"finish"!=k&&"confirm"!=k&&"ready"!=k||a("ready"),i()}),r.on("all",function(e,t){switch(e){case"uploadFinished":a("confirm",t);break;case"startUpload":editor.getOpt("videoUploadService")(l,editor).setUploaderOptions(r),a("uploading",t);break;case"stopUpload":a("paused",t)}}),r.on("uploadBeforeSend",function(e,t,i){editor.getOpt("videoUploadService")(l,editor).setFormData(e,t,i)}),r.on("uploadProgress",function(e,t){var a=d("#"+e.id),o=a.find(".progress span");o.css("width",100*t+"%"),S[e.id][1]=t,i()}),r.on("uploadSuccess",function(e,t){var i=d("#"+e.id);try{editor.getOpt("videoUploadService")(l,editor).getResponseSuccess(t)?(w.push({url:t.url,type:t.mimetype,original:t.original||""}),i.append('<span class="success"></span>')):i.find(".error").text(t.message).show()}catch(e){i.find(".error").text(lang.errorServerUpload).show()}}),r.on("uploadError",function(e,t){}),r.on("error",function(t,i){"Q_TYPE_DENIED"!=t&&"F_EXCEED_SIZE"!=t||e(i)}),r.on("uploadComplete",function(e,t){}),v.on("click",function(){if(d(this).hasClass("disabled"))return!1;"ready"===k?window.setTimeout(function(){r.upload()},500):"paused"===k?window.setTimeout(function(){r.upload()},500):"uploading"===k&&r.stop()}),v.addClass("state-"+k),i()):d("#filePickerReady").after(d("<div>").html(lang.errorLoadConfig)).hide():d("#filePickerReady").after(d("<div>").html(lang.errorNotSupport)).hide()},getQueueCount:function(){var e,t,i,a=0,o=this.uploader.getFiles();for(t=0;e=o[t++];)i=e.getStatus(),"queued"!=i&&"uploading"!=i&&"progress"!=i||a++;return a},refresh:function(){this.uploader.refresh()}}})();